function AppConstants() {}

AppConstants.SIGN_IN_WITH_CREDENTIALS = "POST /signInWithCredentials";
AppConstants.RENEW_AUTH_TOKEN = "GET renewAuthToken";

AppConstants.GET_BRANDS = "GET /brands";
AppConstants.POST_BRANDS = "POST /brands";
AppConstants.DELETE_BRANDS = "DELETE /brands/:id";
var controller = {};
var model = {vo: {}, request: {}, delegate: {}};
var view = {components: {}};

function ApplicationFacade(multitonKey) {
    puremvc.Facade.call(this, multitonKey);
}

ApplicationFacade.prototype = Object.create(puremvc.Facade.prototype);
ApplicationFacade.prototype.constructor = ApplicationFacade;

ApplicationFacade.prototype.initializeController = function() {
    puremvc.Facade.prototype.initializeController.call(this);
    this.registerCommand(ApplicationFacade.STARTUP, controller.StartupCommand);
};


ApplicationFacade.prototype.startup = function() {
    this.sendNotification(this.constructor.STARTUP);
};

ApplicationFacade.getInstance = function(multitonKey) {
    if(puremvc.Facade.instanceMap[multitonKey] == null) {
        puremvc.Facade.instanceMap[multitonKey] = new ApplicationFacade(multitonKey);
    }
    return puremvc.Facade.instanceMap[multitonKey];
};

ApplicationFacade.STARTUP = 'startup';
ApplicationFacade.SERVICE = 'service';
ApplicationFacade.SERVICE_RESULT = 'serviceResult';
ApplicationFacade.SERVICE_FAULT = 'serviceFault';
(function(){

    function ServiceCommand(){
        puremvc.SimpleCommand.call(this);
    }

    ServiceCommand.prototype = Object.create(puremvc.SimpleCommand.prototype);
    ServiceCommand.prototype.constructor = ServiceCommand;

    ServiceCommand.prototype.execute = function(notification) {
        var requestVO = notification.getBody();
        var serviceRequest = new model.request.ServiceRequest(requestVO, this.result, this);
        var serviceProxy = this.facade.retrieveProxy(model.ServiceProxy.NAME);

        switch(requestVO.getRequestType()) {
            case AppConstants.SIGN_IN_WITH_CREDENTIALS:
                serviceProxy.login(serviceRequest);
                break;
            case AppConstants.GET_BRANDS:
                serviceProxy.getBrands(serviceRequest);
                break;
        }
    };

    ServiceCommand.prototype.result = function(notification) {
        var serviceRequest = notification.getBody();
        switch (notification.getName()) {
            case model.request.ServiceRequest.RESULT:
                this.sendNotification(ApplicationFacade.SERVICE_RESULT, serviceRequest.getRequestVO());
                break;
            case model.request.ServiceRequest.FAULT:
                this.sendNotification(ApplicationFacade.SERVICE_FAULT, serviceRequest.getRequestVO());
                break;
        }
    };

    controller.ServiceCommand = ServiceCommand;

}());
(function(){

    function StartupCommand(){
        puremvc.SimpleCommand.call(this);
    }

    StartupCommand.prototype = Object.create(puremvc.SimpleCommand.prototype);
    StartupCommand.prototype.constructor = StartupCommand;

    StartupCommand.prototype.execute = function(notification) {
        this.facade.registerCommand(ApplicationFacade.SERVICE, controller.ServiceCommand);
        this.facade.registerProxy(new model.ServiceProxy());
        this.facade.registerMediator(new view.ApplicationMediator());
    };

    controller.StartupCommand = StartupCommand;

}());
(function(){

    function ServiceProxy(data) {
        puremvc.Proxy.call(this, this.constructor.NAME, data);
        this.entitlement = new model.delegate.Entitlement();
        this.brand = new model.delegate.Brand();
    }

    ServiceProxy.prototype = Object.create(puremvc.Proxy.prototype);
    ServiceProxy.prototype.constructor = ServiceProxy;

    ServiceProxy.prototype.login = function(serviceRequest) {
        this.entitlement.signInWithCredentials(serviceRequest.getRequestVO())
            .then(this.result.bind(this, serviceRequest), this.fault.bind(this, serviceRequest));
    };

    ServiceProxy.prototype.getBrands = function(serviceRequest) {
        this.brand.get(serviceRequest.getRequestVO())
            .then(this.result.bind(this, serviceRequest), this.fault.bind(this, serviceRequest));
    };

    ServiceProxy.prototype.result = function(serviceRequest) {
        if(serviceRequest.hasCallback()) {
            serviceRequest.notifyObserver(new puremvc.Notification(model.request.ServiceRequest.RESULT, serviceRequest));
        }
    };

    ServiceProxy.prototype.fault = function(serviceRequest) {
        if(serviceRequest .hasCallback && serviceRequest.hasCallback()) {
            serviceRequest.notifyObserver(new puremvc.Notification(model.request.ServiceRequest.FAULT, serviceRequest));
        } else {
            console.log(serviceRequest);
        }
    };

    ServiceProxy.NAME = 'ServiceProxy';

    model.ServiceProxy = ServiceProxy;

}());
(function(){

    function ApplicationMediator() {
        puremvc.Mediator.call(this, this.constructor.NAME, new view.components.Application());
    }

    ApplicationMediator.prototype = Object.create(puremvc.Mediator.prototype);
    ApplicationMediator.prototype.constructor = ApplicationMediator;

    ApplicationMediator.prototype.onRegister = function() {
        var self = this;
        function IDelegate(){
            this.service = self.service.bind(self);
        }
        this.viewComponent.setDelegate(new IDelegate());
        this.viewComponent.creationComplete();
    };

    ApplicationMediator.prototype.service = function(requestVO) {
        this.sendNotification(ApplicationFacade.SERVICE, requestVO);
    };

    ApplicationMediator.prototype.listNotificationInterests = function() {
        return [
            ApplicationFacade.SERVICE_RESULT,
            ApplicationFacade.SERVICE_FAULT
        ];
    };

    ApplicationMediator.prototype.handleNotification = function(notification) {
        switch(notification.getName()) {
            case ApplicationFacade.SERVICE_RESULT:
                this.viewComponent.service_result(notification.getBody());
                break;
            case ApplicationFacade.SERVICE_FAULT:
                this.viewComponent.service_fault(notification.getBody());
                break;
        }
    };

    ApplicationMediator.NAME = 'ApplicationMediator';

    view.ApplicationMediator = ApplicationMediator;

}());
(function(){

    function Brand() {
    }

    Brand.prototype.get = function(requestVO) {
        return new Promise(function(resolve, reject){
            var xmlHttpRequest = new XMLHttpRequest();
            xmlHttpRequest.open("GET", "http://localhost:8080/brands", true);
            xmlHttpRequest.onreadystatechange = function() {
                if (xmlHttpRequest.readyState === 4) {
                    try {
                        var data = JSON.parse(xmlHttpRequest.response);
                    } catch (error) {
                        requestVO.setResultData(error);
                        reject(requestVO);
                        return;
                    }
                    if(xmlHttpRequest.status === 200) {
                        requestVO.setResultData(data);
                        resolve(requestVO);
                    } else {
                        requestVO.setResultData(data);
                        reject(requestVO);
                    }
                }
            };
            xmlHttpRequest.addEventListener("error", function(error){
                requestVO.setResultData(error);
                reject(requestVO);
            });
            xmlHttpRequest.send();
        });
    };

    model.delegate.Brand = Brand;

})();
(function(){

    function Entitlement() {}

    Entitlement.prototype.signInWithCredentials = function(requestVO) {
        return new Promise(function(resolve, reject){
            var body = '<credentials> \
                            <emailAddress>' + requestVO.getRequestData().username + '</emailAddress> \
                            <password>' + requestVO.getRequestData().password + '</password> \
                        </credentials>';

            var xmlHttpRequest = new XMLHttpRequest();
            xmlHttpRequest.open("POST", "http://localhost:8080/entitlement/SignInWithCredentials", true);
            xmlHttpRequest.onreadystatechange = function() {
                if (xmlHttpRequest.readyState === 4) {
                    if(xmlHttpRequest.status === 200) {
                        requestVO.setResultData(xmlHttpRequest.responseXML);
                        resolve(requestVO);
                    } else {
                        requestVO.setResultData(xmlHttpRequest.responseXML);
                        reject(requestVO);
                    }
                }
            };
            xmlHttpRequest.addEventListener("error", function(error){
                requestVO.setResultData(error);
                reject(requestVO);
            });
            xmlHttpRequest.send(body);
        });
    };

    model.delegate.Entitlement = Entitlement;

})();
(function(){

    function RequestVO(requestData, requestType) {
        this.requestData = requestData;
        this.requestType = requestType;
    }

    RequestVO.prototype.getRequestData = function() {
        return this.requestData;
    };

    RequestVO.prototype.getRequestType = function() {
        return this.requestType;
    };

    RequestVO.prototype.setResultData = function(resultData) {
        this.resultData = resultData;
    };

    RequestVO.prototype.getResultData = function() {
        return this.resultData;
    };

    model.vo.RequestVO = RequestVO;

}());
(function(){

    function ServiceRequest(requestVO, callback, caller) {
        puremvc.Observer.call(this, callback, caller);
        this.requestVO = requestVO;
    }

    ServiceRequest.prototype = Object.create(puremvc.Observer.prototype);
    ServiceRequest.prototype.constructor = ServiceRequest;

    ServiceRequest.prototype.setObserver = function(callback, caller) {
        this.setNotifyMethod(callback);
        this.setNotifyContext(caller);
    };

    ServiceRequest.prototype.hasCallback = function() {
        return this.getNotifyContext() && this.getNotifyContext();
    };

    ServiceRequest.prototype.getRequestVO = function() {
        return this.requestVO;
    };

    ServiceRequest.RESULT = 'result';
    ServiceRequest.FAULT = 'fault';

    model.request.ServiceRequest = ServiceRequest;

}());
(function(){

    function Application() {
        var self = this;
        function IDelegate(){
            this.service = self.service.bind(self);
        }
        var delegate = new IDelegate();
        this.login = new view.components.Login(delegate);
        this.brand = new view.components.Brand(delegate);
        location.hash = "";
        window.onhashchange = this.onhashchange.bind(this);
    }

    Application.prototype.onhashchange = function(event) {
        this.login.onhashchange(event);
        this.brand.onhashchange(event);
    };

    Application.prototype.creationComplete = function() {
    };

    Application.prototype.service = function(requestVO) {
        this.delegate.service(requestVO);
    };

    Application.prototype.service_result = function(requestVO) {
        console.log(requestVO.getRequestType());
        switch (requestVO.getRequestType()) {
            case AppConstants.SIGN_IN_WITH_CREDENTIALS:
                this.login.signInWithCredentials_success(requestVO);
                break;
            case AppConstants.GET_BRANDS:
                this.brand.brandGet_success(requestVO);
                break;
        }
    };

    Application.prototype.service_fault = function(requestVO) {
        console.error(requestVO.getRequestType());
        console.log(requestVO.getResultData());
        switch (requestVO.getRequestType()) {
            case AppConstants.SIGN_IN_WITH_CREDENTIALS:
                this.login.signInWithCredentials_fail(requestVO);
                break;
        }
    };

    Application.prototype.setDelegate = function(delegate) {
        this.delegate = delegate;
    };

    Application.prototype.delegate = null;

    view.components.Application = Application;

}());
(function(){

    function Brand(delegate) {
        this.delegate = delegate;
        document.getElementById("brandAdd").addEventListener("click", this.brand_save.bind(this));
    }

    Brand.prototype.brand_save = function(event) {
        console.log(event);
    };

    Brand.prototype.brandGet_success = function(requestVO) {
        var data = requestVO.getResultData();
        for(var i=0; i<data.length; i++) {
            console.log(data[i]);

            var p = document.createElement("p");
            p.innerHTML = data[i].name;
        }
    };

    Brand.prototype.onhashchange = function(event) {
        var hash = location.hash.slice(2);
        if(hash.indexOf("/brand") == -1) return;
        switch(hash) {
            case "/brands":
                this.delegate.service(new model.vo.RequestVO(null, AppConstants.GET_BRANDS));
                break;
        }
    };

    view.components.Brand = Brand;

})();
(function(){

    function Login(delegate) {
        this.delegate = delegate;
        this.username = document.getElementById("username");
        this.password = document.getElementById("password");
        this.loader = document.getElementById("loader");
        this.signIn = document.getElementById("signIn");
        document.getElementById("signIn").addEventListener("click", this.signInWithCredentials.bind(this));

        this.username.value = "admin@realogy.com";
        this.password.value = "admin101!";
    }

    Login.prototype.signInWithCredentials = function(event) {
        if(this.username.value.trim() != "" && this.password.value.trim() != "") {
            this.enableFields(false);
            location.hash = "#!/login";
        }
    };

    Login.prototype.signInWithCredentials_success = function(requestVO) {
        this.enableFields(true);
        localStorage.setItem("authToken", requestVO.getResultData().getElementsByTagName("authToken")[0].firstChild);
        document.getElementById("login").classList.add("hidden");
        document.getElementById("main").classList.remove("hidden");

        document.getElementById("invalid").classList.add("hidden");
        location.hash = "#!/brands";
        // set interval for renewal
    };

    Login.prototype.signInWithCredentials_fail = function(requestVO) {
        this.enableFields(true);
        document.getElementById("invalid").classList.remove("hidden");
    };

    Login.prototype.enableFields = function(enabled) {
        enabled ? this.username.removeAttribute("disabled") : this.username.setAttribute("disabled", "disabled");
        enabled ? this.password.removeAttribute("disabled") : this.password.setAttribute("disabled", "disabled");
        enabled ? this.signIn.removeAttribute("disabled") : this.signIn.setAttribute("disabled", "disabled");
        enabled ? this.loader.classList.add("hidden") : this.loader.classList.remove("invisible");
    };

    Login.prototype.onhashchange = function(event) {
        if(location.hash.indexOf("/login") == -1) return;
        switch(location.hash.slice(2)) {
            case "/login":
                this.delegate.service(new model.vo.RequestVO({username: this.username.value.trim(), password: this.password.value.trim()}, AppConstants.SIGN_IN_WITH_CREDENTIALS));
            break;
        }
    };

    view.components.Login = Login;

})();